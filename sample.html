<!DOCTYPE html>
<!--
  Copyright 2012 Google Inc. All Rights Reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">

    <title>Fusion Tables and Google Maps API Example: Custom Markers</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        font-size: 12px;
      }

      #map-canvas {
        height: 760px;
        width: 80%;
		float: left;
      }
	  
	  #search_bar
	  {
	  width: 20%;
	  float: left;
	  }
	  
    </style>

    <script type="text/javascript"
        src="https://maps.google.com/maps/api/js?sensor=true&libraries=places"></script>
    <script type="text/javascript"
      src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js">
    </script>
	 <script type="text/javascript" src="https://www.google.com/jsapi"></script>
	 <script type="text/javascript">
      document.write('<script type="text/javascript" src="markerClusterer' + (document.location.search.indexOf('packed') > -1 ? '_packed' : '') + '.js"><' + '/script>');
    </script>
    <script type="text/javascript">

      var map;
	  var layer;
	  var marker;
	  var geocoder;
      var defaultRadius = 1069 * 25;
	  var currentRadius = defaultRadius;	
	  var defaultLat = 33.7525050349;
	  var defaultLng = -84.3926583945;
	  var infoWindow = new google.maps.InfoWindow();
      var DEFAULT_ICON_URL = 'http://g.etfv.co/http://www.google.com'
	  var directionsDisplay;
	  var directionsService = new google.maps.DirectionsService();

      var apiKey = 'AIzaSyDKof3ZxONgnXXTklvANb5P1JZ-MpzKDmQ';
      var tableID = '423292';

      // Create variables for the columns you need to retrieve from the table
      // EDIT this list as needed, then find and edit two places below.
      var cordinates = 'location';
      var infowindowContentColumn = 'wikipedia_article';
      var marker_Array = new Array();
	  var i =0;

      

     

      

      function initialize() {

        var query = 'SELECT '
                    + cordinates + ','
                    + infowindowContentColumn + ' FROM '
                    + tableID;
		//fetchData(query);  // begin retrieving data from table, and put it on the map
		var pos;
		geocoder = new google.maps.Geocoder();
		//Navigator Location detection
		if(navigator.geolocation)
		{
		navigator.geolocation.getCurrentPosition(function (position)
		{
		pos = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
		});
		}
		
		//search box code
		var input = document.getElementById('search_address');
		var autocomplete = new google.maps.places.Autocomplete(input);
		
		var lat = defaultLat;
		var lng = defaultLng;
		var myLatlng = new google.maps.LatLng(lat, lng);
        map = new google.maps.Map(document.getElementById('map-canvas'), {
          center: myLatlng,
          zoom: 10,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
		
		layer = new google.maps.FusionTablesLayer({
		query: {
		select: 'cordinates , infowindowContentColumn',
		from: tableID
		},
			
		styles: [{
		markerOptions: {
		iconName: "large_green" }
		}],
		suppressinfowindows : true
	
		});
		 google.maps.event.addListener(layer, 'click', function(event) {
		 
			var html = '<a href="' + event.row[infowindowContentColumn].value + '">' + event.row[infowindowContentColumn].value + '</a>';
            infoWindow.setContent( html);
            infoWindow.open(map);
			var input = event.row[cordinates].value;
			var latlngStr = input.split(" ",2);
			var lat = parseFloat(latlngStr[0]);
			var lng = parseFloat(latlngStr[1]);
			input= new google.maps.LatLng(lat, lng);
			infoWindow.setPosition(input);
			document.getElementById("destination_address").value = input ;
			
          });
		
		
		
		directionsDisplay = new google.maps.DirectionsRenderer();
		 directionsDisplay.setMap(map);
		 directionsDisplay.setPanel(document.getElementById("Directions_Panel"));
		layer.setMap(map);
		
		
      }
	  
	  
	  function queryFusionTable(lat, lng, radius) {

  
	var spatialCondition = 'ST_INTERSECTS(location, CIRCLE(LATLNG(' + lat + ', ' + lng + '),' + radius + ')) '; 
	var markerQuery = 'SELECT ' + cordinates + ', ' + infowindowContentColumn + ' from ' + tableID + ' where ' + spatialCondition;
  
	layer.setOptions({
      query: {
        select: 'location',
        from: tableID,
        where:  spatialCondition
      }
     });
	 
	 //fetchData(markerQuery);
	 map.setZoom(11);
	 map.setCenter(new google.maps.LatLng(lat,lng));
	layer.setMap(map);
	
 }

function nameSearch() {
	addressQuery();
}

function servicesSearch() {
	addressQuery();
}

	// Trim a string
	function trim(str) {
        return str.replace(/^\s+|\s+$/g,"");
    }

	// Handle radius change
	function changeRadius(miles) {
		if (miles != "") {
			currentRadius = miles;
		}
	}

// When the user presses the search button
function addressQuery() {
	// get address from the text field
	
	var address = document.getElementById("search_address").value;
	
	address = trim(address);

	if (address.length == 0) {
		// If the user does not enter an address, use the default values. 
		queryFusionTable(defaultLat, defaultLng, defaultRadius);
	} else {
		// Convert the street address to geocodes. 
		geocoder.geocode( {'address': address}, 
		function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				var latitude = results[0].geometry.location.lat();
				var longitude = results[0].geometry.location.lng();
				
				// If geocoding is successful, update the table and map. 
				queryFusionTable(latitude, longitude, currentRadius); 
			} else {
				alert("Geocode was not successful for the following reason: " + status);
			}
		});
	}
}



	function getDirection()
	{
	// get address from the text field
	var address = document.getElementById("search_address").value;
	var end = document.getElementById("destination_address").value;
	var selectedMode = document.getElementById('mode').value;
	address = trim(address);
	end = trim(end);
	 map.setZoom(11);
	
		
	if (address.length == 0 || end.length == 0)
		{
		// If the user does not enter an address, use the default values. 
		alert("Please enter both Source and Destination")
		} 
	else 
		{
		//Directions
		var request = {
		origin:address,
		destination:end,
		travelMode: google.maps.TravelMode[selectedMode],
		provideRouteAlternatives: true
				};
		directionsService.route(request, function(response, status) 
		{
		if (status == google.maps.DirectionsStatus.OK) {
		directionsDisplay.setDirections(response);
		}
		});
		
		
		}
	}
	
	function Clustering()
	{
	layer.setMap(null);
	mc = new MarkerClusterer(map);
	sendMapQuery("select wikipedia_article, location from " + tableID);
	}

	function sendMapQuery(queryText)
	{
		mc.clearMarkers();
		markers=[];
		var query = new google.visualization.Query("https://www.google.com/fusiontables/gvizdata?tq="+encodeURIComponent(queryText));
		query.send(getData);
	}
	
	function getData(response)
	{
		dataTable = response.getDataTable();
		for(var i=0; i< dataTable.getNumberOfRows();i++){			
			var content = dataTable.getValue(i,0).toString();
			var cordinate = dataTable.getValue(i,1).toString().split(" ");			
			var latlng = new google.maps.LatLng(cordinate[0], cordinate[1]);
			
			var marker = new google.maps.Marker({
				position: latlng,
				map:map
			});
			google.maps.event.addListener(marker, 'click', function(event) {
			var html = '<a href="' + content + '">' + content + '</a>';
			var infowindow = new google.maps.InfoWindow({
			content: html
			});
            infoWindow.setPosition(new google.maps.LatLng(event.latLng.lat(),event.latLng.lng()));
			infoWindow.open(map);
			document.getElementById("destination_address").value = new google.maps.LatLng(event.latLng.lat(),event.latLng.lng());
			
          });
			markers.push(marker);
		
		}
		mc.addMarkers(markers);
	}

	  
	  
	  
	  
	  google.load('visualization', '1', 
            {
              'packages':['corechart', 'table', 'geomap']
            }
    );

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
	<div id="search_bar"> 
	<table>
	<th>
	<td colspan="3">Normal for Spatial Queries, Clustering gets only first 500 rows. <br></td>
	</th>
	<tr><td></td></tr>
	<tr> 
	
	<td> <b><input type="radio" name="Mode" value="2" onclick="initialize()" >Normal </b><td>
	<td><b> <input type="radio" name="Mode" value="1" onclick="Clustering()" checked="true">Clustering </b><td>
	<td></td>
	</tr>
	<tr>
	<td colspan="3"><b>Source Address </b></td>
	</tr>
	<tr>
	<td colspan="3"><input type="text" size="30" id="search_address" /></td>
	</tr>
	<tr>
	<td>within
		<select onchange="changeRadius(this.value)";>
		  <option value="805">0.5 mile</option>
		  <option value="1609">1 mile</option> 
		  <option value="4828">3 miles</option> 
		  <option value="8046">5 miles</option>
		  <option value="16093">10 miles</option>
		  <option value="32186">20 miles</option>
		  <option value="40225" selected="selected">25 miles</option>
		</select>
	</td>
	<td><input type="button" value="Search" onclick="addressQuery()"/><td>
	</tr>
	<tr>
	<td colspan="3"><b>Destination Address</b></td>
	</tr>
	<tr>
	<td colspan="3"><input type="text" size="30" id="destination_address" readonly/></td>
	</tr>
	<tr>
	<td colspan="3">Mode of Travel: <select id="mode">
      <option value="DRIVING">Driving</option>
      <option value="WALKING">Walking</option>
      <option value="BICYCLING">Bicycling</option>
      
    </select></td>
	</tr>
	<tr>
	<td colspan="3"><input type="button" value="Get Directions" onclick="getDirection()" /></td>
	</tr>
	</table>
	 <div id="Directions_Panel"></div>
	</div>
	
    <div id="map-canvas"></div>
  </body>
</html>
